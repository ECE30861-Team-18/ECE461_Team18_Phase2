AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: >
  ECE30861 Team 18 Phase 2 - Serverless Application

Parameters:
  GITHUBTOKEN:
    Type: String
    NoEcho: true
    Description: GitHub token for metadata fetch
  HFTOKEN:
    Type: String
    NoEcho: true
    Description: Hugging Face token for model ingest

Globals:
  Function:
    Runtime: python3.11
    Timeout: 10
    MemorySize: 512
    Environment:
      Variables:
        S3_BUCKET: ece30861-team18-model-storage
        ENVIRONMENT: dev
        SECRET_NAME: DB_CREDS
        GITHUB_TOKEN: !Ref GITHUBTOKEN
        HF_TOKEN: !Ref HFTOKEN
    Layers:
      - arn:aws:lambda:us-east-1:422216016693:layer:psycopg2-py313-layer-new2:1

Resources:

  #########################################################
  # CloudWatch Log Group for API Gateway
  #########################################################
  ApiGatewayLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /aws/apigateway/${AWS::StackName}-api
      RetentionInDays: 7

  #########################################################
  # API Gateway
  #########################################################
  ece461Ph2Api:
    Type: AWS::Serverless::Api
    Properties:
      StageName: dev
      Description: ECE461 Phase 2 API Gateway (OpenAPI Spec)
      AccessLogSetting:
        DestinationArn: !GetAtt ApiGatewayLogGroup.Arn
        Format: '{"requestId":"$context.requestId","ip":"$context.identity.sourceIp","caller":"$context.identity.caller","user":"$context.identity.user","requestTime":"$context.requestTime","httpMethod":"$context.httpMethod","resourcePath":"$context.resourcePath","status":"$context.status","protocol":"$context.protocol","responseLength":"$context.responseLength","requestHeaders":"$context.requestHeaders","errorMessage":"$context.error.message","errorType":"$context.error.messageString"}'
      MethodSettings:
        - DataTraceEnabled: true
          HttpMethod: "*"
          LoggingLevel: INFO
          ResourcePath: "/*"
          MetricsEnabled: true
      DefinitionBody:
        openapi: 3.0.2
        info:
          title: ECE461 Phase 2 API
          version: 3.3.1

  #########################################################
  # COMPONENTS
  #########################################################
        components:
          schemas:
            Artifact:
              description: Artifact envelope containing metadata and ingest details.
              required:
                - metadata
                - data
              type: object
              properties:
                metadata:
                  $ref: "#/components/schemas/ArtifactMetadata"
                data:
                  $ref: "#/components/schemas/ArtifactData"

            ArtifactData:
              description: |-
                Source location for ingesting an artifact.

                Provide a single downloadable url pointing to a bundle that contains the artifact assets.
              required:
                - url
              type: object
              properties:
                url:
                  description: Artifact source url used during ingest.
                  type: string
                  format: uri
                download_url:
                  description: Direct download link served by your server for retrieving the stored artifact bundle. Present only in responses.
                  type: string
                  format: uri
                  readOnly: true
              example:
                url: https://huggingface.co/openai/whisper-tiny/tree/main
                download_url: https://ec2-10-121-34-12/download/whisper-tiny

            ArtifactType:
              description: "Artifact category."
              type: string
              enum:
                - model
                - dataset
                - code

            ArtifactID:
              description: "Unique identifier for use with artifact endpoints."
              example: "48472749248"
              type: string
              pattern: '^[a-zA-Z0-9\-]+$'

            ArtifactName:
              description: |-
                Name of an artifact.

                - Names should only use typical "keyboard" characters.
                - The name "*" is reserved. See the `/artifacts` API for its meaning.
              type: string

            ArtifactMetadata:
              description: |-
                The `name` is provided when uploading an artifact.

                The `id` is used as an internal identifier for interacting with existing artifacts and distinguishes artifacts that share a name.
              required:
                - name
                - id
                - type
              type: object
              properties:
                name:
                  $ref: "#/components/schemas/ArtifactName"
                id:
                  $ref: "#/components/schemas/ArtifactID"
                type:
                  $ref: "#/components/schemas/ArtifactType"

            ArtifactQuery:
              description: ""
              required:
                - name
              type: object
              properties:
                name:
                  $ref: "#/components/schemas/ArtifactName"
                  description: ""
                types:
                  description: Optional list of artifact types to filter results.
                  type: array
                  items:
                    $ref: "#/components/schemas/ArtifactType"

            ArtifactAuditEntry:
              description: One entry in an artifact's audit history.
              required:
                - user
                - date
                - artifact
                - action
              type: object
              properties:
                user:
                  $ref: "#/components/schemas/User"
                  description: ""
                date:
                  format: date-time
                  description: Date of activity using ISO-8601 Datetime standard in UTC format.
                  type: string
                  example: 2023-03-23T23:11:15Z
                artifact:
                  $ref: "#/components/schemas/ArtifactMetadata"
                  description: ""
                action:
                  description: ""
                  enum:
                    - CREATE
                    - UPDATE
                    - DOWNLOAD
                    - RATE
                    - AUDIT
                  type: string

            ArtifactCost:
              description: Artifact Cost aggregates the total download size (in MB) required for the artifact, optionally including dependencies.
              type: object
              additionalProperties:
                type: object
                properties:
                  standalone_cost:
                    type: number
                    description: The standalone cost of this artifact excluding dependencies. Required when `dependency = true` in the request.
                  total_cost:
                    type: number
                    description: |
                      The total cost of the artifact. When `dependency` is not set, this should return the standalone cost,
                      and when it is set, this field should return the sum of the costs of all the dependencies.

                      For example:

                        Artifact 1 -> Artifact 2 -> Artifact 3, Artifact 4.

                          If dependency = false
                            total_cost = size(artifact_1)
                          If dependency = true
                          total_cost = size(artifact_1 + artifact_2 + artifact_3 + artifact_4)
                required:
                  - total_cost

            ArtifactRegEx:
              description: ""
              required:
                - regex
              type: object
              properties:
                regex:
                  description:
                    A regular expression over artifact names and READMEs that is
                    used for searching for an artifact
                  type: string

            ArtifactLineageNode:
              description: A single node in an artifact lineage graph.
              required:
                - node
              type: object
              properties:
                artifact_id:
                  description: Unique identifier for the node (artifact or external dependency).
                  $ref: "#/components/schemas/ArtifactID"
                name:
                  description: Human-readable label for the node.
                  type: string
                  example: audience-classifier
                source:
                  description: Provenance for how the node was discovered.
                  type: string
                  example: config_json
                metadata:
                  description: Optional metadata captured for lineage analysis.
                  type: object
                  example:
                    repository_url: https://huggingface.co/parvk11/audience_classifier_model
                    sha: 23c9e8adf2

            ArtifactLineageEdge:
              description: Directed relationship between two lineage nodes.
              required:
                - from_node_artifact_id
                - to_node_artifact_id
                - relationship
              type: object
              properties:
                from_node_artifact_id:
                  description: Identifier of the upstream node.
                  $ref: "#/components/schemas/ArtifactID"
                  example: 57382910458
                to_node_artifact_id:
                  description: Identifier of the downstream node.
                  $ref: "#/components/schemas/ArtifactID"
                  example: 38472472949
                relationship:
                  description: Qualitative description of the edge.
                  type: string
                  example: fine_tuning_dataset

            ArtifactLineageGraph:
              description: Complete lineage graph for an artifact.
              required:
                - nodes
                - edges
              type: object
              properties:
                nodes:
                  description: Nodes participating in the lineage graph.
                  type: array
                  items:
                    $ref: "#/components/schemas/ArtifactLineageNode"
                edges:
                  description: Directed edges describing lineage relationships.
                  type: array
                  items:
                    $ref: "#/components/schemas/ArtifactLineageEdge"

            SimpleLicenseCheckRequest:
              description: Request payload for artifact license compatibility analysis.
              required:
                - github_url
              type: object
              properties:
                github_url:
                  description: GitHub repository url to evaluate.
                  type: string
                  format: uri
                  example: https://github.com/google-research/bert

            User:
              description: ""
              required:
                - name
                - is_admin
              type: object
              properties:
                name:
                  description: ""
                  type: string
                  example: Alfalfa
                is_admin:
                  description: Is this user an admin?
                  type: boolean

            UserAuthenticationInfo:
              description: Authentication info for a user
              required:
                - password
              type: object
              properties:
                password:
                  description:
                    "Password for a user. Per the spec, this should be a \"strong\"\
                    \ password."
                  type: string

            ModelRating:
              description: Model rating summary generated by the evaluation service.
              required:
                - name
                - category
                - net_score
                - net_score_latency
                - ramp_up_time
                - ramp_up_time_latency
                - bus_factor
                - bus_factor_latency
                - performance_claims
                - performance_claims_latency
                - license
                - license_latency
                - dataset_and_code_score
                - dataset_and_code_score_latency
                - dataset_quality
                - dataset_quality_latency
                - code_quality
                - code_quality_latency
                - reproducibility
                - reproducibility_latency
                - reviewedness
                - reviewedness_latency
                - tree_score
                - tree_score_latency
                - size_score
                - size_score_latency
              type: object
              properties:
                name:
                  description: Human-friendly label for the evaluated model.
                  type: string
                category:
                  description: Model category assigned during evaluation.
                  type: string
                net_score:
                  format: double
                  description: Overall score synthesizing all metrics.
                  type: number
                net_score_latency:
                  format: double
                  description: Time (seconds) required to compute `net_score`.
                  type: number
                ramp_up_time:
                  format: double
                  description: Ease-of-adoption rating for the model.
                  type: number
                ramp_up_time_latency:
                  format: double
                  description: Time (seconds) required to compute `ramp_up_time`.
                  type: number
                bus_factor:
                  format: double
                  description: Team redundancy score for the upstream project.
                  type: number
                bus_factor_latency:
                  format: double
                  description: Time (seconds) required to compute `bus_factor`.
                  type: number
                performance_claims:
                  format: double
                  description: Alignment between stated and observed performance.
                  type: number
                performance_claims_latency:
                  format: double
                  description: Time (seconds) required to compute `performance_claims`.
                  type: number
                license:
                  format: double
                  description: Licensing suitability score.
                  type: number
                license_latency:
                  format: double
                  description: Time (seconds) required to compute `license`.
                  type: number
                dataset_and_code_score:
                  format: double
                  description: Availability and quality of accompanying datasets and code.
                  type: number
                dataset_and_code_score_latency:
                  format: double
                  description: Time (seconds) required to compute `dataset_and_code_score`.
                  type: number
                dataset_quality:
                  format: double
                  description: Quality rating for associated datasets.
                  type: number
                dataset_quality_latency:
                  format: double
                  description: Time (seconds) required to compute `dataset_quality`.
                  type: number
                code_quality:
                  format: double
                  description: Quality rating for provided code artifacts.
                  type: number
                code_quality_latency:
                  format: double
                  description: Time (seconds) required to compute `code_quality`.
                  type: number
                reproducibility:
                  format: double
                  description: Likelihood that reported results can be reproduced.
                  type: number
                reproducibility_latency:
                  format: double
                  description: Time (seconds) required to compute `reproducibility`.
                  type: number
                reviewedness:
                  format: double
                  description: Measure of peer or community review coverage.
                  type: number
                reviewedness_latency:
                  format: double
                  description: Time (seconds) required to compute `reviewedness`.
                  type: number
                tree_score:
                  format: double
                  description: Supply-chain health score for model dependencies.
                  type: number
                tree_score_latency:
                  format: double
                  description: Time (seconds) required to compute `tree_score`.
                  type: number
                size_score:
                  description: Size suitability scores for common deployment targets.
                  type: object
                  required:
                    - raspberry_pi
                    - jetson_nano
                    - desktop_pc
                    - aws_server
                  properties:
                    raspberry_pi:
                      format: double
                      description: Size score for Raspberry Pi class devices.
                      type: number
                    jetson_nano:
                      format: double
                      description: Size score for Jetson Nano deployments.
                      type: number
                    desktop_pc:
                      format: double
                      description: Size score for desktop deployments.
                      type: number
                    aws_server:
                      format: double
                      description: Size score for cloud server deployments.
                      type: number
                size_score_latency:
                  description: Time (seconds) required to compute `size_score`.
                  format: double
                  type: number
            AuthenticationToken:
              description:
                "The spec permits you to use any token format you like. You could,\
                \ for example, look into JSON Web Tokens (\"JWT\", pronounced \"jots\"): https://jwt.io."
              type: string
            AuthenticationRequest:
              description: ""
              required:
                - user
                - secret
              type: object
              properties:
                user:
                  $ref: "#/components/schemas/User"
                  description: ""
                secret:
                  $ref: "#/components/schemas/UserAuthenticationInfo"
                  description: ""
            EnumerateOffset:
              description: Offset in pagination.
              type: string
              example: "1"
            HealthStatus:
              description: Aggregate health classification for monitored systems.
              type: string
              enum:
                - ok
                - degraded
                - critical
                - unknown
            HealthSummaryResponse:
              description: High-level snapshot summarizing registry health and recent activity.
              required:
                - status
                - checked_at
                - window_minutes
              type: object
              properties:
                status:
                  $ref: "#/components/schemas/HealthStatus"
                checked_at:
                  description: Timestamp when the health snapshot was generated (UTC).
                  type: string
                  format: date-time
                window_minutes:
                  description: Size of the trailing observation window in minutes.
                  type: integer
                  minimum: 5
                uptime_seconds:
                  description: Seconds the registry API has been running.
                  type: integer
                  minimum: 0
                version:
                  description: Running service version or git SHA when available.
                  type: string
                request_summary:
                  $ref: "#/components/schemas/HealthRequestSummary"
                components:
                  description: Rollup of component status ordered by severity.
                  type: array
                  items:
                    $ref: "#/components/schemas/HealthComponentBrief"
                logs:
                  description: Quick links or descriptors for recent log files.
                  type: array
                  items:
                    $ref: "#/components/schemas/HealthLogReference"
            HealthRequestSummary:
              description: Request activity observed within the health window.
              required:
                - window_start
                - window_end
              type: object
              properties:
                window_start:
                  description: Beginning of the aggregation window (UTC).
                  type: string
                  format: date-time
                window_end:
                  description: End of the aggregation window (UTC).
                  type: string
                  format: date-time
                total_requests:
                  description: Number of API requests served during the window.
                  type: integer
                  minimum: 0
                per_route:
                  description: Request counts grouped by API route.
                  type: object
                  additionalProperties:
                    type: integer
                    minimum: 0
                per_artifact_type:
                  description: Request counts grouped by artifact type (model/dataset/code).
                  type: object
                  additionalProperties:
                    type: integer
                    minimum: 0
                unique_clients:
                  description: Distinct API clients observed in the window.
                  type: integer
                  minimum: 0
            HealthComponentBrief:
              description: Lightweight component-level status summary.
              required:
                - id
                - status
              type: object
              properties:
                id:
                  description: Stable identifier for the component (e.g., ingest-worker, metrics).
                  type: string
                display_name:
                  description: Human readable component name.
                  type: string
                status:
                  $ref: "#/components/schemas/HealthStatus"
                issue_count:
                  description: Number of outstanding issues contributing to the status.
                  type: integer
                  minimum: 0
                last_event_at:
                  description: Last significant event timestamp for the component.
                  type: string
                  format: date-time
            HealthComponentCollection:
              description: Detailed health diagnostics broken down per component.
              required:
                - components
                - generated_at
              type: object
              properties:
                components:
                  type: array
                  items:
                    $ref: "#/components/schemas/HealthComponentDetail"
                generated_at:
                  description: Timestamp when the component report was created (UTC).
                  type: string
                  format: date-time
                window_minutes:
                  description: Observation window applied to the component metrics.
                  type: integer
                  minimum: 5
            HealthComponentDetail:
              description: Detailed status, metrics, and log references for a component.
              required:
                - id
                - status
                - observed_at
              type: object
              properties:
                id:
                  description: Stable identifier for the component.
                  type: string
                display_name:
                  description: Human readable component name.
                  type: string
                status:
                  $ref: "#/components/schemas/HealthStatus"
                observed_at:
                  description: Timestamp when data for this component was last collected (UTC).
                  type: string
                  format: date-time
                description:
                  description: Overview of the component's responsibility.
                  type: string
                metrics:
                  $ref: "#/components/schemas/HealthMetricMap"
                issues:
                  type: array
                  items:
                    $ref: "#/components/schemas/HealthIssue"
                timeline:
                  type: array
                  items:
                    $ref: "#/components/schemas/HealthTimelineEntry"
                logs:
                  type: array
                  items:
                    $ref: "#/components/schemas/HealthLogReference"
            HealthMetricMap:
              description: Arbitrary metric key/value pairs describing component performance.
              type: object
              additionalProperties:
                $ref: "#/components/schemas/HealthMetricValue"
            HealthMetricValue:
              description: Flexible representation for metric values.
              oneOf:
                - type: integer
                - type: number
                - type: string
                - type: boolean
            HealthTimelineEntry:
              description: Time-series datapoint for a component metric.
              required:
                - bucket
                - value
              type: object
              properties:
                bucket:
                  description: Start timestamp of the sampled bucket (UTC).
                  type: string
                  format: date-time
                value:
                  description: Observed value for the bucket (e.g., requests per minute).
                  type: number
                unit:
                  description: Unit associated with the metric value.
                  type: string
            HealthIssue:
              description: Outstanding issue or alert impacting a component.
              required:
                - code
                - severity
                - summary
              type: object
              properties:
                code:
                  description: Machine readable issue identifier.
                  type: string
                severity:
                  description: Issue severity.
                  type: string
                  enum:
                    - info
                    - warning
                    - error
                summary:
                  description: Short description of the issue.
                  type: string
                details:
                  description: Extended diagnostic detail and suggested remediation.
                  type: string
            HealthLogReference:
              description: Link or descriptor for logs relevant to a health component.
              required:
                - label
                - url
              type: object
              properties:
                label:
                  description: Human readable log descriptor (e.g., "Ingest Worker 1").
                  type: string
                url:
                  description: Direct link to download or tail the referenced log.
                  type: string
                  format: uri
                tail_available:
                  description: Indicates whether streaming tail access is supported.
                  type: boolean
                last_updated_at:
                  description: Timestamp of the latest log entry available for this reference.
                  type: string
                  format: date-time
  #########################################################
  # COMPONENTS END
  #########################################################
  # PATHS
  #########################################################

        paths:
          /authenticate:
            summary: Authenticate this user -- get an access token.
            description: |-
              If your system supports the authentication scheme described in the spec, then:

              1. The obtained token should be provided to the other endpoints via the "X-Authorization" header.
              2. The "Authorization" header is *required* in your system.

              Otherwise, this endpoint should return HTTP 501 "Not implemented", and the "X-Authorization" header should be unused for the other endpoints.
            put:
              requestBody:
                content:
                  application/json:
                    schema:
                      $ref: "#/components/schemas/AuthenticationRequest"
                    examples:
                      ExampleRequest:
                        value:
                          user:
                            name: ece30861defaultadminuser
                            is_admin: true
                          secret:
                            password: correcthorsebatterystaple123(!__+@**(A'"`;DROP TABLE artifacts;
                required: true
              responses:
                "200":
                  content:
                    application/json:
                      schema:
                        $ref: "#/components/schemas/AuthenticationToken"
                      examples:
                        ExampleResponse:
                          value: '"bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c"'
                  description: Return an AuthenticationToken.
                "400":
                  description:
                    There is missing field(s) in the AuthenticationRequest or it
                    is formed improperly.
                "401":
                  description: The user or password is invalid.
                "501":
                  description: This system does not support authentication.
              operationId: CreateAuthToken
              summary: (NON-BASELINE)
              description: Create an access token.
              x-amazon-apigateway-integration:
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${AuthLambda.Arn}/invocations
                httpMethod: POST
                type: aws_proxy

          /health:
            get:
              summary: "Heartbeat check (BASELINE)"
              description: |-
                Lightweight liveness probe. Returns HTTP 200 when the registry API is reachable.
              operationId: RegistryHealthHeartbeat
              responses:
                "200":
                  description: Service reachable.
              x-amazon-apigateway-integration:
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${HealthLambda.Arn}/invocations
                httpMethod: POST
                type: aws_proxy

          /health/components:
            get:
              summary: "Get component health details (NON-BASELINE)"
              description: |-
                Return per-component health diagnostics, including status, active issues, and log references.
                Use this endpoint to power deeper observability dashboards or for incident debugging.
              operationId: RegistryHealthComponents
              parameters:
                - name: windowMinutes
                  in: query
                  description: "Length of the trailing observation window, in minutes (5-1440). Defaults to 60."
                  required: false
                  schema:
                    type: integer
                    minimum: 5
                    maximum: 1440
                    default: 60
                - name: includeTimeline
                  in: query
                  description: "Set to true to include per-component activity timelines sampled across the window."
                  required: false
                  schema:
                    type: boolean
                    default: false
              responses:
                "200":
                  description: Component-level health detail.
                  content:
                    application/json:
                      schema:
                        $ref: "#/components/schemas/HealthComponentCollection"

              x-amazon-apigateway-integration:
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${HealthComponentLambda.Arn}/invocations
                httpMethod: POST
                type: aws_proxy

          /tracks:
            get:
              summary: "Get the list of tracks a student has planned to implement in their code"
              
              responses:
                "200":
                  description: Return the list of tracks the student plans to implement
                  content:
                    application/json:
                      schema:
                        type: object
                        properties:
                          plannedTracks:
                            type: array
                            description: "List of tracks the student plans to implement"
                            items:
                              type: string
                              enum:
                                - "Performance track"
                                - "Access control track"
                                - "High assurance track"
                                - "Other Security track"

                "500":
                  description: The system encountered an error while retrieving the student's track information.
              
              x-amazon-apigateway-integration:
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${TracksLambda.Arn}/invocations
                httpMethod: POST
                type: aws_proxy      

          /artifacts:
            post:
              operationId: ArtifactsList
              summary: Get artifacts
              description: Get artifacts matching the query.
              parameters:
                - name: X-Authorization
                  in: header
                  required: true
                  schema:
                    $ref: "#/components/schemas/AuthenticationToken"
              responses:
                "200":
                  description: List of artifacts
              x-amazon-apigateway-integration:
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${ListArtifactsLambda.Arn}/invocations
                httpMethod: POST
                type: aws_proxy

          /reset:
            delete:
              operationId: RegistryReset
              summary: Reset the registry
              description: Reset registry to default state.
              parameters:
                - name: X-Authorization
                  in: header
                  required: true
                  schema:
                    $ref: "#/components/schemas/AuthenticationToken"
              responses:
                "200":
                  description: Registry is reset
              x-amazon-apigateway-integration:
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${ResetRegistryLambda.Arn}/invocations
                httpMethod: POST
                type: aws_proxy

          /artifacts/{artifact_type}/{id}:
            get:
              operationId: ArtifactRetrieve
              summary: Retrieve artifact
              description: Get artifact by ID.
              parameters:
                - name: artifact_type
                  in: path
                  required: true
                - name: id
                  in: path
                  required: true
              responses:
                "200":
                  description: Artifact found
              x-amazon-apigateway-integration:
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${GetArtifactLambda.Arn}/invocations
                httpMethod: POST
                type: aws_proxy

            put:
              operationId: ArtifactUpdate
              summary: Update artifact
              description: Update artifact contents.
              parameters:
                - name: artifact_type
                  in: path
                  required: true
                - name: id
                  in: path
                  required: true
              responses:
                "200":
                  description: Artifact updated
              x-amazon-apigateway-integration:
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${UpdateArtifactLambda.Arn}/invocations
                httpMethod: POST
                type: aws_proxy

            delete:
              operationId: ArtifactDelete
              summary: Delete artifact
              description: Delete artifact by ID.
              parameters:
                - name: artifact_type
                  in: path
                  required: true
                - name: id
                  in: path
                  required: true
              responses:
                "200":
                  description: Artifact deleted
              x-amazon-apigateway-integration:
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${DeleteArtifactLambda.Arn}/invocations
                httpMethod: POST
                type: aws_proxy

          /artifact/{artifact_type}:
            post:
              operationId: ArtifactCreate
              summary: Register new artifact
              description: Register new artifact by providing a URL.
              parameters:
                - name: artifact_type
                  in: path
                  required: true
                - name: X-Authorization
                  in: header
                  required: false
              responses:
                "201":
                  description: Artifact created
              x-amazon-apigateway-integration:
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${CreateArtifactLambda.Arn}/invocations
                httpMethod: POST
                type: aws_proxy

          /artifact/byName/{name}:
            get:
              parameters:
                - examples:
                    ExampleName:
                      value: audience-classifier
                  name: name
                  schema:
                    $ref: "#/components/schemas/ArtifactName"
                  in: path
                  required: true
                - examples:
                    ExampleToken:
                      value: bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c
                  name: X-Authorization
                  description: ""
                  schema:
                    $ref: "#/components/schemas/AuthenticationToken"
                  in: header
                  required: false
              responses:
                "200":
                  content:
                    application/json:
                      schema:
                        type: array
                        items:
                          $ref: "#/components/schemas/ArtifactMetadata"
                      examples:
                        AudienceClassifierEntries:
                          value:
                            - name: audience-classifier
                              id: 3847247293
                              type: model
                            - name: audience-classifier
                              id: 3847247294
                              type: model
                            - name: bookcorpus
                              id: 5738291045
                              type: dataset
                  description: Return artifact metadata entries that match the provided name.
                "400":
                  description: "There is missing field(s) in the artifact_name or it is formed improperly, or is invalid."
                "403":
                  description: Authentication failed due to invalid or missing AuthenticationToken.
                "404":
                  description: No such artifact.
              operationId: ArtifactByNameGet
              summary: List artifact metadata for this name. (NON-BASELINE)
              description: Return metadata for each artifact matching this name.
              x-amazon-apigateway-integration:
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${GetArtifactByNameLambda.Arn}/invocations
                httpMethod: POST
                type: aws_proxy

          /artifact/byRegEx:
            post:
              parameters:
                - examples:
                    ExampleToken:
                      value: bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c
                  name: X-Authorization
                  description: ""
                  schema:
                    $ref: "#/components/schemas/AuthenticationToken"
                  in: header
                  required: false
              requestBody:
                content:
                  application/json:
                    schema:
                      $ref: "#/components/schemas/ArtifactRegEx"
                    examples:
                      ExampleRegEx:
                        value:
                          regex: .*?(audience|bert).*
                required: true
              responses:
                "200":
                  content:
                    application/json:
                      schema:
                        type: array
                        items:
                          $ref: "#/components/schemas/ArtifactMetadata"
                      examples:
                        ExampleResponse:
                          value:
                            - name: audience-classifier
                              id: 3847247294
                              type: model
                            - name: openai-whisper
                              id: 7364518290
                              type: code
                            - name: bert-base-uncased
                              id: 9078563412
                              type: model
                  description: Return a list of artifacts.
                "400":
                  description: There is missing field(s) in the artifact_regex or it is formed improperly, or is invalid
                "403":
                  description: Authentication failed due to invalid or missing AuthenticationToken.
                "404":
                  description: No artifact found under this regex.
              operationId: ArtifactByRegExGet
              summary: Get any artifacts fitting the regular expression (BASELINE).
              description:
                Search for an artifact using regular expression over artifact names
                and READMEs. This is similar to search by name.
              x-amazon-apigateway-integration:
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${GetArtifactByRegexLambda.Arn}/invocations
                httpMethod: POST
                type: aws_proxy

          /artifact/model/{id}/rate:
            get:
              parameters:
                - name: id
                  in: path
                  required: true
                  schema:
                    type: string
                - name: X-Authorization
                  in: header
                  required: false
                  schema:
                    type: string
              responses:
                "200":
                  description: Return the rating
                  content:
                    application/json:
                      schema:
                        type: object
                "400":
                  description: Missing or invalid artifact_id
                "403":
                  description: Authentication failed
                "404":
                  description: Artifact does not exist
                "500":
                  description: Rating system error
              operationId: ModelArtifactRate
              summary: Get ratings for this model artifact
              x-amazon-apigateway-integration:
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${RateArtifactLambda.Arn}/invocations
                httpMethod: POST
                type: aws_proxy

          /artifact/{artifact_type}/{id}/cost:
            get:
              parameters:
                - name: artifact_type
                  in: path
                  required: true
                  schema:
                    type: string
                    enum: [model, dataset, code]
                - name: id
                  in: path
                  required: true
                  schema:
                    type: string
                - name: dependency
                  in: query
                  required: false
                  schema:
                    type: boolean
                    default: false
                - name: X-Authorization
                  in: header
                  required: false
                  schema:
                    type: string
              responses:
                "200":
                  description: Return the total cost of the artifact, and its dependencies
                  content:
                    application/json:
                      schema:
                        type: object
                "400":
                  description: Missing or invalid fields
                "403":
                  description: Authentication failed
                "404":
                  description: Artifact does not exist
                "500":
                  description: Cost calculator error
              operationId: ArtifactCost
              summary: Get the cost of an artifact
              x-amazon-apigateway-integration:
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${CostArtifactLambda.Arn}/invocations
                httpMethod: POST
                type: aws_proxy

      Cors:
        AllowMethods: "'OPTIONS,GET,POST,PUT,DELETE'"
        AllowHeaders: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
        AllowOrigin: "'*'"

  #########################################################
  # LAMBDA FUNCTIONS
  #########################################################
  AuthLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: auth_lambda
      Handler: handlers/auth_lambda.lambda_handler
      CodeUri: ./backend/app
      Runtime: python3.11
      Events:
        ApiEvent:
          Type: Api
          Properties:
            Path: /authenticate
            Method: put
            RestApiId: !Ref ece461Ph2Api
      Policies:
        - AWSLambdaBasicExecutionRole

  HealthLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: health_lambda
      Handler: handlers/health_lambda.lambda_handler
      CodeUri: ./backend/app
      Runtime: python3.11
      Description: Health check endpoint
      Events:
        ApiEvent:
          Type: Api
          Properties:
            Path: /health
            Method: any
            RestApiId: !Ref ece461Ph2Api
    Policies:
      - AWSLambdaBasicExecutionRole
  
  TracksLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: tracks_lambda
      Handler: handlers/tracks_lambda.lambda_handler
      CodeUri: ./backend/app
      Runtime: python3.11
      Description: Return track list
      Events:
        ApiEvent:
          Type: Api
          Properties:
            Path: /tracks
            Method: get
            RestApiId: !Ref ece461Ph2Api
      Policies:
        - AWSLambdaBasicExecutionRole

  HealthComponentLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: health_components_lambda
      Handler: handlers/health_components_lambda.lambda_handler
      CodeUri: ./backend/app
      Runtime: python3.11
      Description: Return per-component health diagnostics
      Events:
        ApiEvent:
          Type: Api
          Properties:
            Path: /health/components
            Method: get
            RestApiId: !Ref ece461Ph2Api
    Policies:
      - AWSLambdaBasicExecutionRole

  CreateArtifactLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: create_artifact_lambda
      Handler: handlers/create_artifact_lambda.lambda_handler
      CodeUri: ./backend/app
      Description: Lambda for creating artifacts
      Environment:
        Variables:
          INGEST_QUEUE_URL: https://sqs.us-east-1.amazonaws.com/422216016693/model-ingestion-queue
      Events:
        ApiEvent:
          Type: Api
          Properties:
            Path: /artifact/{artifact_type}
            Method: post
            RestApiId: !Ref ece461Ph2Api
      Policies:
        - AWSLambdaBasicExecutionRole
        - Statement:
            - Effect: Allow
              Action: secretsmanager:GetSecretValue
              Resource: !Sub arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:DB_CREDS-*
            - Effect: Allow
              Action:
                - sqs:SendMessage
              Resource: arn:aws:sqs:us-east-1:422216016693:model-ingestion-queue
  ListArtifactsLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: list_artifacts_lambda
      Handler: handlers/list_artifacts_lambda.lambda_handler
      CodeUri: ./backend/app
      Description: Lambda for listing artifacts
      Events:
        ApiEvent:
          Type: Api
          Properties:
            Path: /artifacts
            Method: post
            RestApiId: !Ref ece461Ph2Api
      Policies:
        - AWSLambdaBasicExecutionRole
        - Statement:
            - Effect: Allow
              Action: secretsmanager:GetSecretValue
              Resource: !Sub arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:DB_CREDS-*

  GetArtifactLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: get_artifact_lambda
      Handler: handlers/get_artifact_lambda.lambda_handler
      CodeUri: ./backend/app
      Description: Lambda for getting an artifact
      Events:
        ApiEvent:
          Type: Api
          Properties:
            Path: /artifacts/{artifact_type}/{id}
            Method: get
            RestApiId: !Ref ece461Ph2Api
      Policies:
        - AWSLambdaBasicExecutionRole
        - Statement:
            - Effect: Allow
              Action: secretsmanager:GetSecretValue
              Resource: !Sub arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:DB_CREDS-*

  UpdateArtifactLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: update_artifact_lambda
      Handler: handlers/update_artifact_lambda.lambda_handler
      CodeUri: ./backend/app
      Description: Lambda for updating artifact
      Events:
        ApiEvent:
          Type: Api
          Properties:
            Path: /artifacts/{artifact_type}/{id}
            Method: put
            RestApiId: !Ref ece461Ph2Api
      Policies:
        - AWSLambdaBasicExecutionRole
        - Statement:
            - Effect: Allow
              Action: secretsmanager:GetSecretValue
              Resource: !Sub arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:DB_CREDS-*

  DeleteArtifactLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: delete_artifact_lambda
      Handler: handlers/delete_artifact_lambda.lambda_handler
      CodeUri: ./backend/app
      Description: Lambda for deleting artifact
      Events:
        ApiEvent:
          Type: Api
          Properties:
            Path: /artifacts/{artifact_type}/{id}
            Method: delete
            RestApiId: !Ref ece461Ph2Api
      Policies:
        - AWSLambdaBasicExecutionRole
        - Statement:
            - Effect: Allow
              Action: secretsmanager:GetSecretValue
              Resource: !Sub arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:DB_CREDS-*

  ResetRegistryLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: reset_registry_lambda
      Handler: handlers/reset_registry_lambda.lambda_handler
      CodeUri: ./backend/app
      Description: Lambda for resetting registry
      Events:
        ApiEvent:
          Type: Api
          Properties:
            Path: /reset
            Method: delete
            RestApiId: !Ref ece461Ph2Api
      Policies:
        - AWSLambdaBasicExecutionRole
        - Statement:
            - Effect: Allow
              Action: secretsmanager:GetSecretValue
              Resource: !Sub arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:DB_CREDS-*

  GetArtifactByNameLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: get_artifact_by_name_lambda
      Handler: handlers/get_artifact_by_name_lambda.lambda_handler
      CodeUri: ./backend/app
      Description: Lambda for getting artifacts by name
      Events:
        ApiEvent:
          Type: Api
          Properties:
            Path: /artifact/byName/{name}
            Method: get
            RestApiId: !Ref ece461Ph2Api
      Policies:
        - AWSLambdaBasicExecutionRole
        - Statement:
            - Effect: Allow
              Action: secretsmanager:GetSecretValue
              Resource: !Sub arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:DB_CREDS-*

  GetArtifactByRegexLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: get_artifact_by_regex_lambda
      Handler: handlers/get_artifact_by_regex_lambda.lambda_handler
      CodeUri: ./backend/app
      Description: Lambda for getting artifacts by regex
      Events:
        ApiEvent:
          Type: Api
          Properties:
            Path: /artifact/byRegEx
            Method: post
            RestApiId: !Ref ece461Ph2Api
      Policies:
        - AWSLambdaBasicExecutionRole
        - Statement:
            - Effect: Allow
              Action: secretsmanager:GetSecretValue
              Resource: !Sub arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:DB_CREDS-*

  RateArtifactLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: rate_artifact_lambda
      Handler: handlers/rate_artifact_lambda.lambda_handler
      CodeUri: ./backend/app
      Description: Lambda for getting model ratings
      Events:
        ApiEvent:
          Type: Api
          Properties:
            Path: /artifact/model/{id}/rate
            Method: get
            RestApiId: !Ref ece461Ph2Api
      Policies:
        - AWSLambdaBasicExecutionRole
        - Statement:
            - Effect: Allow
              Action: secretsmanager:GetSecretValue
              Resource: !Sub arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:DB_CREDS-*
  
  CostArtifactLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: cost_artifact_lambda
      Handler: handlers/cost_artifact_lambda.lambda_handler
      CodeUri: ./backend/app
      Description: Lambda for getting artifact cost
      Events:
        ApiEvent:
          Type: Api
          Properties:
            Path: /artifact/{artifact_type}/{id}/cost
            Method: get
            RestApiId: !Ref ece461Ph2Api
      Policies:
        - AWSLambdaBasicExecutionRole
        - Statement:
            - Effect: Allow
              Action: secretsmanager:GetSecretValue
              Resource: !Sub arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:DB_CREDS-*
  
  
  #########################################################
  # LAMBDA INVOKE PERMISSIONS (for API Gateway)
  #########################################################
  HealthPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !GetAtt HealthLambda.Arn 
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${ece461Ph2Api}/*/*/*


  GetTracksPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !GetAtt TracksLambda.Arn
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${ece461Ph2Api}/*/*/*

  CreateArtifactPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !GetAtt CreateArtifactLambda.Arn
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${ece461Ph2Api}/*/*/*

  ListArtifactsPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !GetAtt ListArtifactsLambda.Arn
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${ece461Ph2Api}/*/*/*

  GetArtifactPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !GetAtt GetArtifactLambda.Arn
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${ece461Ph2Api}/*/*/*

  UpdateArtifactPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !GetAtt UpdateArtifactLambda.Arn
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${ece461Ph2Api}/*/*/*

  DeleteArtifactPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !GetAtt DeleteArtifactLambda.Arn
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${ece461Ph2Api}/*/*/*

  ResetRegistryPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !GetAtt ResetRegistryLambda.Arn
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${ece461Ph2Api}/*/*/*

  GetArtifactByNamePermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !GetAtt GetArtifactByNameLambda.Arn
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${ece461Ph2Api}/*/*/*

  GetArtifactByRegexPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !GetAtt GetArtifactByRegexLambda.Arn
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${ece461Ph2Api}/*/*/*


Outputs:
  ApiEndpoint:
    Description: "API Gateway endpoint URL"
    Value: !Sub "https://${ece461Ph2Api}.execute-api.${AWS::Region}.amazonaws.com/dev"